# Stage II: Node Generator

## Objective

Train a Generative Adversarial Network (GAN) to generate synthetic user nodes, and visualize the distribution of real and synthetic nodes using t-SNE.

This stage learns the distribution of fraudulent and benign users to generate realistic synthetic user nodes that can be used to balance the dataset.

## Prerequisites

- **Stage I must be completed**: User and product embeddings must exist
  - `embed/music_hgt_user_emb.pt`
  - `embed/music_hgt_product_emb.pt`

## Execution Command

### Basic Usage

```bash
python3 node_generator.py \
    --gpu_id 0 \
    --n_epochs 5 \
    --gan_verbose 1 \
    --tsne_verbose 1
```

### Advanced Usage

```bash
python3 node_generator.py \
    --gpu_id 2 \
    --n_epochs 5 \
    --gan_dir "example_gan/" \
    --gan_verbose 1 \
    --tsne_dir "example_tsne/" \
    --tsne_verbose 1 \
    --save_tsne_figure True
```

## Parameter Description

| Parameter | Description | Default | Recommended |
|-----------|-------------|---------|-------------|
| `--n_epochs` | Number of GAN training epochs | 200 | 5 for demo, 200+ for production |
| `--batch_size` | Batch size | 64 | 64 (adjust based on GPU memory) |
| `--lr` | Learning rate | 0.0002 | 0.0002 (Adam optimizer) |
| `--latent_dim` | Latent space dimension | 128 | 128 |
| `--emb_dim` | Embedding dimension | 256 | 256 (must match Stage I) |
| `--gan_dir` | Directory for GAN models | `./generator/` | Custom if needed |
| `--gan_verbose` | Show GAN training details (0/1) | 0 | 1 (to monitor progress) |
| `--tsne_dir` | Directory for t-SNE figures | `./tsne/` | Custom if needed |
| `--tsne_verbose` | t-SNE verbosity level (0/1/2) | 0 | 1 or 2 |
| `--save_tsne_figure` | Save t-SNE figures | True | True |

## Output Files

### Model Files

- **Discriminator**: `generator/music_D.pt`
  - Trained discriminator model that distinguishes real from fake users

- **Generator**: `generator/music_G.pt`
  - Trained generator model that creates synthetic user embeddings

### t-SNE Visualization Figures

The following visualization files are generated in the `tsne/` directory:

| File | Description |
|------|-------------|
| `tsne.jpg` | All nodes distribution (real + fake, benign + spam) |
| `tsne_real_benign.jpg` | Real benign users only |
| `tsne_real_spam.jpg` | Real spam users only |
| `tsne_fake_benign.jpg` | Synthetic benign users generated by GAN |
| `tsne_fake_spam.jpg` | Synthetic spam users generated by GAN |
| `tsne_real_fake.jpg` | Comparison of real vs synthetic users |

### t-SNE Visualization Purpose

These visualizations help you:
1. **Verify GAN quality**: Synthetic nodes should overlap with real nodes
2. **Check class separation**: Benign and spam users should be distinguishable
3. **Validate generation**: Fake nodes should match the distribution of real nodes

## Expected Output

### During Training

```
Epoch 1/5:
  D Loss: 0.xxxx
  G Loss: 0.xxxx
  ...
Epoch 5/5:
  D Loss: 0.xxxx
  G Loss: 0.xxxx

GAN models saved to:
  - generator/music_D.pt
  - generator/music_G.pt

Generating t-SNE visualizations...
t-SNE figures saved to:
  - tsne/tsne.jpg
  - tsne/tsne_real_benign.jpg
  - tsne/tsne_real_spam.jpg
  - tsne/tsne_fake_benign.jpg
  - tsne/tsne_fake_spam.jpg
  - tsne/tsne_real_fake.jpg
```

## Execution Time

- **GAN Training**:
  - Demo (5 epochs): ~10 minutes
  - Production (200+ epochs): ~1-2 hours

- **t-SNE Visualization**: ~10 minutes

*Total time for demo: ~20 minutes*

## Verification

### Check Model Files

```bash
ls -lh generator/
```

Expected output:
```
-rw-r--r-- 1 user user 2.1M music_D.pt
-rw-r--r-- 1 user user 1.8M music_G.pt
```

### Check t-SNE Figures

```bash
ls -lh tsne/
```

### Visualize Results

```bash
# View t-SNE plots
open tsne/tsne.jpg  # macOS
xdg-open tsne/tsne.jpg  # Linux
```

### Test Generator

```python
import torch
from hgt_model import Generator, latent_dim, emb_dim

# Load generator
G = Generator(latent_dim, emb_dim)
G.load_state_dict(torch.load('generator/music_G.pt'))
G.eval()

# Generate synthetic users
z = torch.randn(10, latent_dim)
fake_users = G(z)
print(f"Generated {fake_users.shape[0]} synthetic users")
print(f"Embedding dimension: {fake_users.shape[1]}")
```

## Understanding t-SNE Results

### Good GAN Training Indicators

✅ **Overlapping distributions**: Fake nodes should overlap with real nodes
✅ **Similar cluster structure**: Fake nodes should form similar clusters
✅ **Clear class separation**: Benign and spam should be distinguishable

### Poor GAN Training Indicators

❌ **Mode collapse**: All fake nodes clustered in one area
❌ **No overlap**: Fake nodes completely separated from real nodes
❌ **Uniform distribution**: Fake nodes spread uniformly (not learning structure)
